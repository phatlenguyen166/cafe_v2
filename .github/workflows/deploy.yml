name: Java CI/CD with Maven

# KÃ­ch hoáº¡t workflow khi cÃ³ push tá»›i nhÃ¡nh `main`
on:
  push:
    branches: ["main"]

jobs:
  build-and-deploy:
    # Cháº¡y job trÃªn má»™t mÃ¡y áº£o Ubuntu má»›i nháº¥t
    runs-on: ubuntu-latest

    steps:
      # --- PHáº¦N CI (TÃ­ch há»£p liÃªn tá»¥c) ---

      # BÆ°á»›c 1: Láº¥y mÃ£ nguá»“n
      - name: Checkout code
        uses: actions/checkout@v4

      # BÆ°á»›c 2: CÃ i Ä‘áº·t JDK 17 vÃ  cache Maven
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      # BÆ°á»›c 3: Build vÃ  Ä‘Ã³ng gÃ³i á»©ng dá»¥ng
      - name: Build with Maven
        run: mvn -B package --file pom.xml
        # File JAR sáº½ Ä‘Æ°á»£c táº¡o táº¡i `target/cafe_v2-0.0.1-SNAPSHOT.jar`

      # --- PHáº¦N CD (Triá»ƒn khai liÃªn tá»¥c) ---

      # BÆ°á»›c 4: Sao chÃ©p file JAR tá»›i Server (VPS)
      # YÃªu cáº§u: Cáº¥u hÃ¬nh cÃ¡c secrets DEPLOY_HOST, DEPLOY_USERNAME, DEPLOY_KEY, DEPLOY_PATH
      - name: Deploy to Server via SCP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USERNAME }}
          key: ${{ secrets.DEPLOY_KEY }}
          port: 22
          source: "target/*.jar" # THAY Äá»”I: DÃ¹ng wildcard Ä‘á»ƒ tá»± Ä‘á»™ng tÃ¬m file .jar
          target: ${{ secrets.DEPLOY_PATH }}

      # BÆ°á»›c 5: Khá»Ÿi Ä‘á»™ng láº¡i á»©ng dá»¥ng trÃªn Server
      - name: Restart application on Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USERNAME }}
          key: ${{ secrets.DEPLOY_KEY }}
          port: 22
          script: |
            echo "--- Báº¯t Ä‘áº§u script triá»ƒn khai trÃªn server ---"
            cd ${{ secrets.DEPLOY_PATH }}

            echo "1. Kiá»ƒm tra file vÃ  quyá»n háº¡n:"
            ls -la

            echo "2. Kiá»ƒm tra phiÃªn báº£n Java:"
            # Kiá»ƒm tra xem Java cÃ³ tá»“n táº¡i khÃ´ng
            if ! command -v java &> /dev/null
            then
                echo "Lá»–I: KhÃ´ng tÃ¬m tháº¥y Java trÃªn server. Vui lÃ²ng cÃ i Ä‘áº·t Java (JRE) hoáº·c kiá»ƒm tra biáº¿n mÃ´i trÆ°á»ng PATH."
                exit 1
            fi
            java -version

            echo "3. Dá»«ng tiáº¿n trÃ¬nh á»©ng dá»¥ng cÅ©:"
            PID=$(ps -ef | grep cafe-0.0.1-SNAPSHOT.jar | grep -v grep | awk '{print $2}')
            if [ -n "$PID" ]; then
              echo "ðŸ”´ Tiáº¿n trÃ¬nh Ä‘ang cháº¡y: $PID"
              kill -9 $PID || true
            else
              echo "âœ… KhÃ´ng cÃ³ tiáº¿n trÃ¬nh Java nÃ o Ä‘ang cháº¡y."
            fi

            # echo "4. TÃ¬m vÃ  khá»Ÿi Ä‘á»™ng file JAR má»›i:"
            # TÃ¬m file .jar má»›i nháº¥t Ä‘á»ƒ trÃ¡nh lá»—i náº¿u cÃ³ nhiá»u file
            # JAR_FILE=$(ls -t *.jar | head -n 1)
            # if [ -z "$JAR_FILE" ]
            # then
            #   echo "Lá»–I: KhÃ´ng tÃ¬m tháº¥y file .jar nÃ o trong thÆ° má»¥c ${{ secrets.DEPLOY_PATH }}"
            #   exit 1
            # fi

            # echo "Khá»Ÿi Ä‘á»™ng file: $JAR_FILE"
            nohup java -jar target/cafe-0.0.1-SNAPSHOT.jar > cafeLogApp.log 2>&1 &

            echo "--- Script triá»ƒn khai Ä‘Ã£ hoÃ n táº¥t ---"
